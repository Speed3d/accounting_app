// lib/screens/reports/manage_categories_screen.dart

import 'package:flutter/material.dart';
import '../../data/database_helper.dart';
import '../../l10n/app_localizations.dart';
import '../../theme/app_colors.dart';
import '../../theme/app_constants.dart';
import '../../widgets/custom_card.dart';
import '../../widgets/custom_text_field.dart';
import '../../widgets/loading_state.dart';

/// ๐ ุดุงุดุฉ ุฅุฏุงุฑุฉ ูุฆุงุช ุงููุตุงุฑูู
/// ---------------------------
/// **ุงููุธููุฉ ุงูุฃุณุงุณูุฉ:**
/// ุตูุญุฉ ูุฑุนูุฉ ูุชุฎุตุตุฉ ูู ุฅุฏุงุฑุฉ ูุฆุงุช ุงููุตุงุฑูู (CRUD Operations)
/// ุชูููู ุงููุณุชุฎุฏู ูู ุฅูุดุงุก ูุชุนุฏูู ูุญุฐู ูุฆุงุช ุงููุตุงุฑูู ุงููุณุชุฎุฏูุฉ ูู ุงูุชุทุจูู
/// 
/// **ุงูุนูููุงุช ุงููุชุงุญุฉ:**
/// 1. **ุนุฑุถ (Read)**: ูุงุฆูุฉ ุจุฌููุน ุงููุฆุงุช ุงููุณุฌูุฉ ูุฑุชุจุฉ ุฃุจุฌุฏูุงู
/// 2. **ุฅุถุงูุฉ (Create)**: ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ ูุน ุงูุชุญูู ูู ุนุฏู ุงูุชูุฑุงุฑ
/// 3. **ุชุนุฏูู (Update)**: ุชุนุฏูู ุงุณู ูุฆุฉ ููุฌูุฏุฉ
/// 4. **ุญุฐู (Delete)**: ุญุฐู ูุฆุฉ ูุน ุชุฃููุฏ ูู ุงููุณุชุฎุฏู
/// 
/// **ุงูููุฒุงุช:**
/// - โ ูุงุฌูุฉ ุจุณูุทุฉ ูุณููุฉ ุงูุงุณุชุฎุฏุงู
/// - โ Validation ูุงูู ูููุน ุงูุฃุณูุงุก ุงูููุฑุฑุฉ
/// - โ ุชุฃููุฏ ูุจู ุงูุญุฐู
/// - โ Pull to Refresh
/// - โ Empty State ูุน ุฏุนูุฉ ููุฅุถุงูุฉ
/// - โ ุฑุณุงุฆู ูุงุถุญุฉ ูููุฌุงุญ ูุงูุฎุทุฃ
/// - โ ุฏุนู ูุงูู ููุชุฑุฌูุฉ (l10n)
/// 
/// **ุงูุนูุงูุฉ ูุน ุงูุดุงุดุงุช ุงูุฃุฎุฑู:**
/// - ูุชู ุงุณุชุฏุนุงุคูุง ูู `ExpensesScreen` ุนุจุฑ ุฒุฑ ูู AppBar
/// - ุงูุชุบููุฑุงุช ุชูุนูุณ ูุจุงุดุฑุฉ ูู ูุงุฆูุฉ ุงููุฆุงุช ูู `ExpensesScreen`
/// 
/// **ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
/// - ุงูุฌุฏูู: `TB_Expense_Categories`
/// - ุงูุฃุนูุฏุฉ: `CategoryID`, `CategoryName`
/// - ุงูููุฏ: `CategoryName` ูุฌุจ ุฃู ูููู ูุฑูุฏุงู (UNIQUE)
/// 
/// **ุงูุงุณุชุฎุฏุงู:**
/// ```dart
/// Navigator.push(
///   context,
///   MaterialPageRoute(
///     builder: (context) => const ManageCategoriesScreen(),
///   ),
/// );
/// ```
/// 
/// **ููุงุญุธุงุช ูููุฉ:**
/// - โ๏ธ ุญุฐู ูุฆุฉ ูุง ูุญุฐู ุงููุตุงุฑูู ุงููุฑุชุจุทุฉ ุจูุง (ูุฏ ูุญุชุงุฌ ุชุญุณูู ูุณุชูุจูู)
/// - โ๏ธ ูุง ููุฌุฏ ุญุฏ ุฃูุตู ูุนุฏุฏ ุงููุฆุงุช
/// - โ ุงููุฆุงุช ุงูุงูุชุฑุงุถูุฉ ูุญููุฉ ูู ุงูุญุฐู ูู ุงูุฅุตุฏุงุฑุงุช ุงููุณุชูุจููุฉ
class ManageCategoriesScreen extends StatefulWidget {
  const ManageCategoriesScreen({super.key});

  @override
  State<ManageCategoriesScreen> createState() => _ManageCategoriesScreenState();
}

class _ManageCategoriesScreenState extends State<ManageCategoriesScreen> {
  // ============================================================================
  // ๐ฆ ุงููุชุบูุฑุงุช - Variables
  // ============================================================================
  
  /// Hint: ูุซูู ูู DatabaseHelper ููุชุนุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
  /// ูููุฑ ุฏูุงู ุฌุงูุฒุฉ ููุนูููุงุช CRUD ุนูู ุฌุฏูู TB_Expense_Categories
  final dbHelper = DatabaseHelper.instance;
  
  /// Hint: Future ูุญูู ูุงุฆูุฉ ุงููุฆุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  /// ูู ุนูุตุฑ ูู ุงููุงุฆูุฉ ูู Map ูุญุชูู ุนูู CategoryID ู CategoryName
  /// ูุชู ุชุญุฏูุซู ุนูุฏ ูู ุนูููุฉ ุฅุถุงูุฉ/ุญุฐู/ุชุนุฏูู ูุถูุงู ุชุญุฏูุซ ุงููุงุฌูุฉ
  late Future<List<Map<String, dynamic>>> _categoriesFuture;

  // ============================================================================
  // ๐ฌ ุฏูุฑุฉ ุงูุญูุงุฉ - Lifecycle
  // ============================================================================
  
  @override
  void initState() {
    super.initState();
    // Hint: ุชุญููู ุงูุจูุงูุงุช ุงูุฃูููุฉ ุนูุฏ ูุชุญ ุงูุดุงุดุฉ
    _loadCategories();
  }

  // ============================================================================
  // ๐ ุฏูุงู ุงูุชุญููู - Loading Functions
  // ============================================================================
  
  /// ุฏุงูุฉ ูุชุญููู ูุงุฆูุฉ ุงููุฆุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  /// 
  /// **ุงููุธููุฉ:**
  /// - ุชุณุชุฏุนู ุฏุงูุฉ `getExpenseCategories()` ูู DatabaseHelper
  /// - ุชุญูุธ ุงููุชูุฌุฉ ูู `_categoriesFuture`
  /// - ุชุณุชุฏุนู `setState()` ูุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฌูุฉ ุจุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
  /// 
  /// **ูุชู ุชูุณุชุฏุนู:**
  /// - ุนูุฏ ูุชุญ ุงูุดุงุดุฉ ูุฃูู ูุฑุฉ (ูู initState)
  /// - ุจุนุฏ ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ ุจูุฌุงุญ
  /// - ุจุนุฏ ุชุนุฏูู ูุฆุฉ ููุฌูุฏุฉ
  /// - ุจุนุฏ ุญุฐู ูุฆุฉ
  /// - ุนูุฏ Pull to Refresh ูู ูุจู ุงููุณุชุฎุฏู
  /// 
  /// **ููุงุญุธุฉ:**
  /// ุงูุจูุงูุงุช ูุฑุชุจุฉ ุฃุจุฌุฏูุงู (ASC) ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ
  void _loadCategories() {
    setState(() {
      // Hint: ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฌุฏูู ูุญูุธูุง ูู Future
      // ูุชู ุงูุชุฑุชูุจ ุฃุจุฌุฏูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
      _categoriesFuture = dbHelper.getExpenseCategories();
    });
  }

  // ============================================================================
  // ๐จ ุงูุจูุงุก ุงูุฑุฆูุณู - Main Build
  // ============================================================================
  
  @override
  Widget build(BuildContext context) {
    // Hint: ุฌูุจ ูุตูุต ุงูุชุฑุฌูุฉ ูู ููู l10n
    // ุฅุฐุง ูุงู nullุ ูุณุชุฎุฏู ูุตูุต ุงูุชุฑุงุถูุฉ ููุฃูุงู
    final l10n = AppLocalizations.of(context);
    
    return Scaffold(
      // ============================================================================
      // ๐ฑ AppBar - ุงูุดุฑูุท ุงูุนููู
      // ============================================================================
      appBar: AppBar(
        // Hint: ุงูุนููุงู ูุฃุชู ูู ููู ุงูุชุฑุฌูุฉ ูุน fallback
        title: Text(l10n?.manageCategoriesTitle ?? 'ุฅุฏุงุฑุฉ ูุฆุงุช ุงููุตุงุฑูู'),
        elevation: 0,
      ),

      // ============================================================================
      // ๐ ุงูุฌุณู ุงูุฑุฆูุณู - Body
      // ============================================================================
      body: FutureBuilder<List<Map<String, dynamic>>>(
        future: _categoriesFuture,
        builder: (context, snapshot) {
          // ============================================================================
          // โณ ุญุงูุฉ ุงูุชุญููู - Loading State
          // ============================================================================
          if (snapshot.connectionState == ConnectionState.waiting) {
            // Hint: ุนุฑุถ ูุคุดุฑ ุงูุชุญููู ุงูุฏุงุฆุฑู ูุน ุฑุณุงูุฉ
            return LoadingState(
              message: l10n?.loadingCategories ?? 'ุฌุงุฑู ุชุญููู ุงููุฆุงุช...',
            );
          }

          // ============================================================================
          // โ ุญุงูุฉ ุงูุฎุทุฃ - Error State
          // ============================================================================
          if (snapshot.hasError) {
            // Hint: ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุน ุฅููุงููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
            return ErrorState(
              message: l10n?.loadError ?? 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช',
              onRetry: _loadCategories,
            );
          }

          // ============================================================================
          // ๐ญ ุญุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุช - Empty State
          // ============================================================================
          if (!snapshot.hasData || snapshot.data!.isEmpty) {
            // Hint: ุนุฑุถ ุฑุณุงูุฉ ูุฏุนูุฉ ูุฅุถุงูุฉ ุฃูู ูุฆุฉ
            return EmptyState(
              icon: Icons.category_outlined,
              title: l10n?.noCategories ?? 'ูุง ุชูุฌุฏ ูุฆุงุช',
              message: l10n?.noCategoriesMessage ?? 
                       'ูู ูุชู ุฅุถุงูุฉ ุฃู ูุฆุฉ ูููุตุงุฑูู ุญุชู ุงูุขู',
              actionText: l10n?.addCategory ?? 'ุฅุถุงูุฉ ูุฆุฉ',
              onAction: () => _showCategoryDialog(),
            );
          }

          // ============================================================================
          // โ ุญุงูุฉ ุนุฑุถ ุงูุจูุงูุงุช - Data Display
          // ============================================================================
          final categories = snapshot.data!;

          return ListView.builder(
            padding: AppConstants.screenPadding,
            itemCount: categories.length,
            itemBuilder: (context, index) {
              final category = categories[index];
              // Hint: ุจูุงุก ุจุทุงูุฉ ููู ูุฆุฉ ูุน ุฃุฒุฑุงุฑ ุงูุชุนุฏูู ูุงูุญุฐู
              return _buildCategoryCard(category);
            },
          );
        },
      ),

      // ============================================================================
      // โ ุฒุฑ ุงูุฅุถุงูุฉ ุงูุนุงุฆู - FAB
      // ============================================================================
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () => _showCategoryDialog(),
        icon: const Icon(Icons.add),
        label: Text(l10n?.addCategory ?? 'ุฅุถุงูุฉ ูุฆุฉ'),
        tooltip: l10n?.newCategory ?? 'ูุฆุฉ ุฌุฏูุฏุฉ',
      ),
    );
  }

  // ============================================================================
  // ๐ด ุจูุงุก ุจุทุงูุฉ ุงููุฆุฉ - Category Card Builder
  // ============================================================================
  
  /// ุฏุงูุฉ ูุจูุงุก ุจุทุงูุฉ ุนุฑุถ ูุฆุฉ ูุงุญุฏุฉ
  /// 
  /// **ุงููุนุงููุงุช:**
  /// - `category`: Map ูุญุชูู ุนูู ุจูุงูุงุช ุงููุฆุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  ///   * CategoryID: int - ุงููุนุฑู ุงููุฑูุฏ ูููุฆุฉ
  ///   * CategoryName: String - ุงุณู ุงููุฆุฉ
  /// 
  /// **ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ:**
  /// - ุฃููููุฉ Label ูู ุฏุงุฆุฑุฉ ููููุฉ
  /// - ุงุณู ุงููุฆุฉ ุจุฎุท ูุงุถุญ
  /// - ุฒุฑ ุชุนุฏูู (ุฃููููุฉ ููู ุจุงูููู ุงูุฃุฒุฑู)
  /// - ุฒุฑ ุญุฐู (ุฃููููุฉ ุณูุฉ ููููุงุช ุจุงูููู ุงูุฃุญูุฑ)
  /// 
  /// **ุงูุชูุงุนู:**
  /// - ุงูููุฑ ุนูู ุฒุฑ ุงูุชุนุฏูู: ูุชุญ ูุงูุฐุฉ ุงูุชุนุฏูู
  /// - ุงูููุฑ ุนูู ุฒุฑ ุงูุญุฐู: ูุชุญ ูุงูุฐุฉ ุชุฃููุฏ ุงูุญุฐู
  /// 
  /// **ุงูุชุตููู:**
  /// - CustomCard ูุน ุญูุงู ุฏุงุฆุฑูุฉ
  /// - ListTile ูุน padding ููุงุณุจ
  /// - ุฃููููุฉ Leading ูู ุญุงููุฉ ุฏุงุฆุฑูุฉ
  /// - Row ูู ุงูุฃุฒุฑุงุฑ ูู Trailing
  Widget _buildCategoryCard(Map<String, dynamic> category) {
    final l10n = AppLocalizations.of(context);
    
    // Hint: ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู Map
    final categoryId = category['CategoryID'] as int;
    final categoryName = category['CategoryName'] as String;

    return CustomCard(
      margin: const EdgeInsets.only(bottom: AppConstants.spacingMd),
      child: ListTile(
        contentPadding: AppConstants.listTilePadding,
        
        // ============================================================================
        // ๐ท๏ธ ุฃููููุฉ ุงููุฆุฉ - Leading Icon
        // ============================================================================
        // Hint: ุญุงููุฉ ุฏุงุฆุฑูุฉ ุจุฎูููุฉ ููููุฉ ูุงุชุญุฉ ูุฃููููุฉ Label
        leading: Container(
          width: 48,
          height: 48,
          decoration: BoxDecoration(
            color: AppColors.primaryLight.withOpacity(0.1),
            borderRadius: AppConstants.borderRadiusMd,
          ),
          child: Icon(
            Icons.label,
            color: AppColors.primaryLight,
            size: 24,
          ),
        ),

        // ============================================================================
        // ๐ ุงุณู ุงููุฆุฉ - Title
        // ============================================================================
        // Hint: ูุต ุบุงูู ูุงุถุญ ูุนุฑุถ ุงุณู ุงููุฆุฉ
        title: Text(
          categoryName,
          style: const TextStyle(
            fontWeight: FontWeight.w600,
            fontSize: 18,
          ),
        ),

        // ============================================================================
        // ๐ง ุฃุฒุฑุงุฑ ุงูุชุนุฏูู ูุงูุญุฐู - Action Buttons
        // ============================================================================
        // Hint: Row ูุญุชูู ุนูู ุฒุฑูู (ุชุนุฏูู ูุญุฐู)
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            // --- ุฒุฑ ุงูุชุนุฏูู ---
            // Hint: ุฃููููุฉ ููู ุจุงูููู ุงูุฃุฒุฑู
            IconButton(
              icon: const Icon(Icons.edit_outlined),
              color: AppColors.info,
              tooltip: l10n?.edit ?? 'ุชุนุฏูู',
              onPressed: () => _showCategoryDialog(
                existingCategory: category,
              ),
            ),

            // --- ุฒุฑ ุงูุญุฐู ---
            // Hint: ุฃููููุฉ ุณูุฉ ููููุงุช ุจุงูููู ุงูุฃุญูุฑ
            IconButton(
              icon: const Icon(Icons.delete_outline),
              color: AppColors.error,
              tooltip: l10n?.delete ?? 'ุญุฐู',
              onPressed: () => _handleDeleteCategory(
                categoryId,
                categoryName,
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ============================================================================
  // โ ูุงูุฐุฉ ุฅุถุงูุฉ/ุชุนุฏูู ูุฆุฉ - Add/Edit Category Dialog
  // ============================================================================
  
  /// ุฏุงูุฉ ูุนุฑุถ ูุงูุฐุฉ ุญูุงุฑ ูุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ ุฃู ุชุนุฏูู ูุฆุฉ ููุฌูุฏุฉ
  /// 
  /// **ุงููุนุงููุงุช:**
  /// - `existingCategory`: Map ุงุฎุชูุงุฑู ูุญุชูู ุนูู ุจูุงูุงุช ุงููุฆุฉ ุงููุฑุงุฏ ุชุนุฏูููุง
  ///   * ุฅุฐุง ูุงู null: ูุถุน ุงูุฅุถุงูุฉ (Create)
  ///   * ุฅุฐุง ูุงู ููุฌูุฏ: ูุถุน ุงูุชุนุฏูู (Update)
  /// 
  /// **ุงูุฎุทูุงุช ูู ูุถุน ุงูุฅุถุงูุฉ:**
  /// 1. ุนุฑุถ ูููุฐุฌ ูุงุฑุบ
  /// 2. ุงููุณุชุฎุฏู ูุฏุฎู ุงุณู ุงููุฆุฉ
  /// 3. Validation ููุชุฃูุฏ ูู ุนุฏู ุชุฑู ุงูุญูู ูุงุฑุบุงู
  /// 4. ุญูุธ ุงููุฆุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  /// 5. ูุนุงูุฌุฉ ุฎุทุฃ ุงูุงุณู ุงูููุฑุฑ
  /// 6. ุชุญุฏูุซ ุงููุงุฆูุฉ
  /// 
  /// **ุงูุฎุทูุงุช ูู ูุถุน ุงูุชุนุฏูู:**
  /// 1. ุนุฑุถ ุงููููุฐุฌ ูุน ุงูุงุณู ุงูุญุงูู
  /// 2. ุงููุณุชุฎุฏู ูุนุฏู ุงูุงุณู
  /// 3. Validation ููุงุซู ููุฅุถุงูุฉ
  /// 4. ุชุญุฏูุซ ุงููุฆุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  /// 5. ูุนุงูุฌุฉ ุฎุทุฃ ุงูุงุณู ุงูููุฑุฑ
  /// 6. ุชุญุฏูุซ ุงููุงุฆูุฉ
  /// 
  /// **ุงูู Validation:**
  /// - ุงูุญูู ูุง ูููู ุฃู ูููู ูุงุฑุบุงู
  /// - ุงูุงุณู ูุฌุจ ุฃู ูููู ูุฑูุฏุงู (ูุชู ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
  /// 
  /// **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
  /// - ุฎุทุฃ ุงูุงุณู ุงูููุฑุฑ: ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
  /// - ุฃู ุฎุทุฃ ุขุฎุฑ: ุฑุณุงูุฉ ุฎุทุฃ ุนุงูุฉ ูุน ุงูุชูุงุตูู
  void _showCategoryDialog({Map<String, dynamic>? existingCategory}) {
    final l10n = AppLocalizations.of(context);
    
    // Hint: ุฅูุดุงุก ููุชุงุญ ูููููุฐุฌ ููุชุญูู ูู ุงูู Validation
    final formKey = GlobalKey<FormState>();
    
    // Hint: Controller ููุญูู ุงููุตูุ ูููุฃู ุจุงูุงุณู ุงูุญุงูู ุฅุฐุง ูุงู ุชุนุฏูู
    final nameController = TextEditingController(
      text: existingCategory?['CategoryName'],
    );
    
    // Hint: ุชุญุฏูุฏ ุงููุถุน: ูู ูุญู ูู ุญุงูุฉ ุฅุถุงูุฉ ุฃู ุชุนุฏููุ
    final isEditing = existingCategory != null;

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        // ============================================================================
        // ๐ ุนููุงู ุงููุงูุฐุฉ - Dialog Title
        // ============================================================================
        // Hint: ุงูุนููุงู ูุชุบูุฑ ุญุณุจ ุงููุถุน (ุฅุถุงูุฉ ุฃู ุชุนุฏูู)
        title: Row(
          children: [
            Icon(
              isEditing ? Icons.edit : Icons.add_circle_outline,
              size: 28,
            ),
            const SizedBox(width: 12),
            Text(
              isEditing 
                  ? (l10n?.editCategory ?? 'ุชุนุฏูู ุงููุฆุฉ')
                  : (l10n?.addNewCategory ?? 'ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ')
            ),
          ],
        ),

        // ============================================================================
        // ๐ ูุญุชูู ุงููููุฐุฌ - Form Content
        // ============================================================================
        content: Form(
          key: formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // ============================================================================
              // ๐ ุญูู ุงุณู ุงููุฆุฉ - Category Name Field
              // ============================================================================
              // Hint: ุญูู ูุตู ูุน Validation ููุชุฃูุฏ ูู ุนุฏู ุชุฑู ุงูุญูู ูุงุฑุบุงู
              CustomTextField(
                controller: nameController,
                label: l10n?.categoryName ?? 'ุงุณู ุงููุฆุฉ',
                hint: l10n?.categoryNameHint ?? 'ูุซุงู: ููุงุชูุฑุ ุฅูุฌุงุฑุ ุตูุงูุฉ',
                prefixIcon: Icons.label_outlined,
                validator: (value) {
                  // Hint: ุงูุชุญูู ูู ุฃู ุงูุญูู ููุณ ูุงุฑุบุงู
                  if (value == null || value.isEmpty) {
                    return l10n?.categoryNameRequired ?? 'ุงุณู ุงููุฆุฉ ูุทููุจ';
                  }
                  return null;
                },
              ),
            ],
          ),
        ),

        // ============================================================================
        // ๐ ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช - Action Buttons
        // ============================================================================
        actions: [
          // --- ุฒุฑ ุงูุฅูุบุงุก ---
          // Hint: ุฅุบูุงู ุงููุงูุฐุฉ ุจุฏูู ุญูุธ
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: Text(l10n?.cancel ?? 'ุฅูุบุงุก'),
          ),

          // --- ุฒุฑ ุงูุญูุธ/ุงูุชุญุฏูุซ ---
          // Hint: ุงููุต ูุงูุฃููููุฉ ุชุชุบูุฑ ุญุณุจ ุงููุถุน
          ElevatedButton.icon(
            onPressed: () async {
              // ============================================================================
              // โ ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
              // ============================================================================
              if (!formKey.currentState!.validate()) return;

              try {
                // Hint: ุงุณุชุฎุฑุงุฌ ุงูุงุณู ุงููุฏุฎู ูุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
                final categoryName = nameController.text.trim();

                // ============================================================================
                // ๐พ ุงูุฎุทูุฉ 2: ุญูุธ ุฃู ุชุญุฏูุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                // ============================================================================
                if (isEditing) {
                  // --- ูุถุน ุงูุชุนุฏูู ---
                  // Hint: ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุชุญุฏูุซ ูุน ID ุงููุฆุฉ
                  await dbHelper.updateExpenseCategory(
                    existingCategory['CategoryID'],
                    categoryName,
                  );
                } else {
                  // --- ูุถุน ุงูุฅุถุงูุฉ ---
                  // Hint: ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุฅุถุงูุฉ
                  await dbHelper.addExpenseCategory(categoryName);
                }

                if (!ctx.mounted) return;

                // ============================================================================
                // โ ุงูุฎุทูุฉ 3: ุฅุบูุงู ุงููุงูุฐุฉ ูุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
                // ============================================================================
                Navigator.pop(ctx);

                // Hint: ุฑุณุงูุฉ ูุฌุงุญ ุชุฎุชูู ุญุณุจ ุงููุถุน
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      isEditing
                          ? (l10n?.categoryUpdatedSuccess ?? 'ุชู ุชุนุฏูู ุงููุฆุฉ ุจูุฌุงุญ')
                          : (l10n?.categoryAddedSuccess ?? 'ุชู ุฅุถุงูุฉ ุงููุฆุฉ ุจูุฌุงุญ'),
                    ),
                    backgroundColor: AppColors.success,
                  ),
                );

                // ============================================================================
                // ๐ ุงูุฎุทูุฉ 4: ุชุญุฏูุซ ุงููุงุฆูุฉ
                // ============================================================================
                _loadCategories();
                
              } catch (e) {
                // ============================================================================
                // โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
                // ============================================================================
                // Hint: ุงูุฎุทุฃ ุงูุฃูุซุฑ ุดููุนุงู ูู ุงุณู ููุฑุฑ ุจุณุจุจ UNIQUE constraint
                if (!ctx.mounted) return;

                Navigator.pop(ctx);

                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(l10n?.categoryAlreadyExists ?? 'ูุฐู ุงููุฆุฉ ููุฌูุฏุฉ ุจุงููุนู'),
                    backgroundColor: AppColors.warning,
                  ),
                );
              }
            },
            icon: Icon(isEditing ? Icons.check : Icons.save),
            label: Text(
              isEditing 
                  ? (l10n?.update ?? 'ุชุญุฏูุซ')
                  : (l10n?.save ?? 'ุญูุธ')
            ),
          ),
        ],
      ),
    );
  }

  // ============================================================================
  // ๐๏ธ ุญุฐู ูุฆุฉ - Delete Category
  // ============================================================================
  
  /// ุฏุงูุฉ ูุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ุญุฐู ูุฆุฉ
  /// 
  /// **ุงููุนุงููุงุช:**
  /// - `categoryId`: int - ูุนุฑู ุงููุฆุฉ ุงููุฑุงุฏ ุญุฐููุง
  /// - `categoryName`: String - ุงุณู ุงููุฆุฉ (ููุนุฑุถ ูู ุฑุณุงูุฉ ุงูุชุฃููุฏ)
  /// 
  /// **ุงูุฎุทูุงุช:**
  /// 1. ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ูุน ุฃููููุฉ ุชุญุฐูุฑ
  /// 2. ุนุฑุถ ุงุณู ุงููุฆุฉ ุจุดูู ูุงุถุญ
  /// 3. ุชุญุฐูุฑ ุงููุณุชุฎุฏู ูู ุฃู ุงูุนูููุฉ ูุง ูููู ุงูุชุฑุงุฌุน ุนููุง
  /// 4. ูู ุญุงูุฉ ุงูุชุฃููุฏ:
  ///    - ุญุฐู ุงููุฆุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  ///    - ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
  ///    - ุชุญุฏูุซ ุงููุงุฆูุฉ
  /// 5. ูู ุญุงูุฉ ุงูุฎุทุฃ:
  ///    - ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ ูุน ุงูุชูุงุตูู
  /// 
  /// **ููุงุญุธุงุช:**
  /// - โ๏ธ ูุง ูุชุญูู ูู ูุฌูุฏ ูุตุงุฑูู ูุฑุชุจุทุฉ ุจุงููุฆุฉ (ุชุญุณูู ูุณุชูุจูู)
  /// - ุงูุญุฐู ููุงุฆู ููุง ูููู ุงูุชุฑุงุฌุน ุนูู
  /// - ูููุตุญ ุจุฅุถุงูุฉ ุขููุฉ Soft Delete ูู ุงูุฅุตุฏุงุฑุงุช ุงููุณุชูุจููุฉ
  void _handleDeleteCategory(int categoryId, String categoryName) {
    final l10n = AppLocalizations.of(context);
    
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        // ============================================================================
        // โ๏ธ ุฃููููุฉ ุงูุชุญุฐูุฑ - Warning Icon
        // ============================================================================
        // Hint: ุฃููููุฉ ูุจูุฑุฉ ุจุงูููู ุงูุจุฑุชูุงูู ูุฌุฐุจ ุงูุงูุชุจุงู
        icon: const Icon(
          Icons.warning_amber_rounded,
          color: AppColors.warning,
          size: 48,
        ),

        // ============================================================================
        // ๐ ุนููุงู ุงูุชุฃููุฏ - Confirmation Title
        // ============================================================================
        title: Text(l10n?.confirmDelete ?? 'ุชุฃููุฏ ุงูุญุฐู'),

        // ============================================================================
        // ๐ ุฑุณุงูุฉ ุงูุชุฃููุฏ - Confirmation Message
        // ============================================================================
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // --- ุงูุณุคุงู ุงูุชุฃููุฏู ---
            Text(
              l10n?.deleteConfirmationQuestion ?? 'ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุฆุฉุ',
              style: Theme.of(context).textTheme.bodyLarge,
              textAlign: TextAlign.center,
            ),
            
            const SizedBox(height: AppConstants.spacingMd),
            
            // --- ุนุฑุถ ุงุณู ุงููุฆุฉ ูู ุตูุฏูู ูููู ---
            // Hint: ุตูุฏูู ุฃุญูุฑ ูุงุชุญ ูุชุณููุท ุงูุถูุก ุนูู ุงููุฆุฉ ุงููุฑุงุฏ ุญุฐููุง
            Container(
              padding: AppConstants.paddingMd,
              decoration: BoxDecoration(
                color: AppColors.error.withOpacity(0.1),
                borderRadius: AppConstants.borderRadiusMd,
              ),
              child: Text(
                categoryName,
                style: const TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
            ),
            
            const SizedBox(height: AppConstants.spacingMd),
            
            // --- ุฑุณุงูุฉ ุงูุชุญุฐูุฑ ุงูููุงุฆูุฉ ---
            // Hint: ุชุญุฐูุฑ ูุงุถุญ ุจุฃู ุงูุนูููุฉ ูุง ูููู ุงูุชุฑุงุฌุน ุนููุง
            Text(
              l10n?.deleteWarning ?? 'ุณูุชู ุญุฐู ุงููุฆุฉ ููุงุฆูุงู ููู ูููู ุงุณุชุฑุฌุงุนูุง',
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                    color: AppColors.error,
                  ),
              textAlign: TextAlign.center,
            ),
          ],
        ),

        // ============================================================================
        // ๐ ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช - Action Buttons
        // ============================================================================
        actions: [
          // --- ุฒุฑ ุงูุฅูุบุงุก ---
          // Hint: ุฅุบูุงู ุงููุงูุฐุฉ ุจุฏูู ุญุฐู
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: Text(l10n?.cancel ?? 'ุฅูุบุงุก'),
          ),

          // --- ุฒุฑ ุงูุญุฐู ---
          // Hint: ุฒุฑ ุฃุญูุฑ ูุชุฃููุฏ ุฎุทูุฑุฉ ุงูุนูููุฉ
          ElevatedButton.icon(
            onPressed: () async {
              try {
                // ============================================================================
                // ๐๏ธ ุญุฐู ุงููุฆุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                // ============================================================================
                await dbHelper.deleteExpenseCategory(categoryId);

                if (!ctx.mounted) return;

                // ุฅุบูุงู ูุงูุฐุฉ ุงูุชุฃููุฏ
                Navigator.pop(ctx);

                // ุฑุณุงูุฉ ูุฌุงุญ
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(l10n?.categoryDeletedSuccess ?? 'ุชู ุญุฐู ุงููุฆุฉ ุจูุฌุงุญ'),
                    backgroundColor: AppColors.success,
                  ),
                );

                // ุชุญุฏูุซ ุงููุงุฆูุฉ
                _loadCategories();
                
              } catch (e) {
                // ============================================================================
                // โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
                // ============================================================================
                if (!ctx.mounted) return;

                Navigator.pop(ctx);

                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text('${l10n?.errorOccurred ?? "ุญุฏุซ ุฎุทุฃ"}: $e'),
                    backgroundColor: AppColors.error,
                  ),
                );
              }
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.error,
              foregroundColor: Colors.white,
            ),
            icon: const Icon(Icons.delete),
            label: Text(l10n?.delete ?? 'ุญุฐู'),
          ),
        ],
      ),
    );
  }
}