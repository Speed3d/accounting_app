// ๐ lib/services/translation_service.dart

import 'package:translator/translator.dart';

/// ๐ ุฎุฏูุฉ ุงูุชุฑุฌูุฉ ุงูุชููุงุฆูุฉ
///
/// โ Hint: ุชุณุชุฎุฏู Google Translate API (ูุฌุงูู - ุบูุฑ ุฑุณูู)
/// โ Hint: ุงูุงุณุชุฎุฏุงู ุงูุฑุฆูุณู: ุชุฑุฌูุฉ ุฃุณูุงุก ุงูุชุตูููุงุช ูุงููุญุฏุงุช
///
/// ุงูููุฒุงุช:
/// โ ุชุฑุฌูุฉ ูู ุงูุนุฑุจูุฉ ููุฅูุฌููุฒูุฉ
/// โ ุชุฑุฌูุฉ ูู ุงูุฅูุฌููุฒูุฉ ููุนุฑุจูุฉ
/// โ ุงูุชุดุงู ุงููุบุฉ ุชููุงุฆูุงู
/// โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก (ูู ุงูุฅูุชุฑูุช ููุทูุน)
/// โ timeout ูุชุฌูุจ ุงูุชุนููู
///
/// ๐ ูููุณุชูุจู:
/// - ุฅุถุงูุฉ cache ููุชุฑุฌูุงุช (ูุชุฌูุจ ุชุฑุฌูุฉ ููุณ ุงููููุฉ ูุฑุชูู)
/// - ุฅุถุงูุฉ ุฏุนู ููุบุงุช ุฃุฎุฑู
/// - ุฅุถุงูุฉ ุชุฑุฌูุฉ ุฏูุนุฉ ูุงุญุฏุฉ (batch translation)
class TranslationService {
  // ============================================================================
  // ๐ง ุงููุซูู ุงููุญูุฏ (Singleton)
  // ============================================================================

  static final TranslationService _instance = TranslationService._internal();
  factory TranslationService() => _instance;
  TranslationService._internal();

  // ============================================================================
  // ๐ง ุงููุชุฑุฌู
  // ============================================================================

  final GoogleTranslator _translator = GoogleTranslator();

  // ============================================================================
  // ๐ง ุงูุฅุนุฏุงุฏุงุช
  // ============================================================================

  /// โ Hint: ุงููุฏุฉ ุงููุตูู ููุงูุชุธุงุฑ (5 ุซูุงูู)
  static const Duration _timeout = Duration(seconds: 5);

  // ============================================================================
  // ๐ ุฏูุงู ุงูุชุฑุฌูุฉ
  // ============================================================================

  /// ุชุฑุฌูุฉ ูุต ูู ุงูุนุฑุจูุฉ ุฅูู ุงูุฅูุฌููุฒูุฉ
  ///
  /// โ Hint: ุชุณุชุฎุฏู ุนูุฏ ุงููุชุงุจุฉ ูู ุญูู ุงูุนุฑุจูุฉ
  ///
  /// ุงููุนุงููุงุช:
  /// - [text] ุงููุต ุงููุฑุงุฏ ุชุฑุฌูุชู
  ///
  /// ุงูุนูุฏุฉ:
  /// - ุงููุต ุงููุชุฑุฌูุ ุฃู null ูู ุญุงูุฉ ุงููุดู
  Future<String?> translateToEnglish(String text) async {
    try {
      // โ Hint: ุงูุชุญูู ูู ุฃู ุงููุต ููุณ ูุงุฑุบุงู
      if (text.trim().isEmpty) {
        return null;
      }

      // โ Hint: ุงูุชุฑุฌูุฉ ูุน timeout
      final translation = await _translator
          .translate(text, from: 'ar', to: 'en')
          .timeout(_timeout);

      return translation.text;

    } catch (e) {
      // โ Hint: ูู ุญุงูุฉ ุงูุฎุทุฃ (ูุง ุฅูุชุฑูุชุ timeoutุ ุฅูุฎ)
      return null;
    }
  }

  /// ุชุฑุฌูุฉ ูุต ูู ุงูุฅูุฌููุฒูุฉ ุฅูู ุงูุนุฑุจูุฉ
  ///
  /// โ Hint: ุชุณุชุฎุฏู ุนูุฏ ุงููุชุงุจุฉ ูู ุญูู ุงูุฅูุฌููุฒูุฉ
  ///
  /// ุงููุนุงููุงุช:
  /// - [text] ุงููุต ุงููุฑุงุฏ ุชุฑุฌูุชู
  ///
  /// ุงูุนูุฏุฉ:
  /// - ุงููุต ุงููุชุฑุฌูุ ุฃู null ูู ุญุงูุฉ ุงููุดู
  Future<String?> translateToArabic(String text) async {
    try {
      // โ Hint: ุงูุชุญูู ูู ุฃู ุงููุต ููุณ ูุงุฑุบุงู
      if (text.trim().isEmpty) {
        return null;
      }

      // โ Hint: ุงูุชุฑุฌูุฉ ูุน timeout
      final translation = await _translator
          .translate(text, from: 'en', to: 'ar')
          .timeout(_timeout);

      return translation.text;

    } catch (e) {
      // โ Hint: ูู ุญุงูุฉ ุงูุฎุทุฃ (ูุง ุฅูุชุฑูุชุ timeoutุ ุฅูุฎ)
      return null;
    }
  }

  /// ุชุฑุฌูุฉ ุชููุงุฆูุฉ ูุน ุงูุชุดุงู ุงููุบุฉ
  ///
  /// โ Hint: ุชูุชุดู ุงููุบุฉ ุชููุงุฆูุงู ูุชุชุฑุฌู ููุบุฉ ุงูููุงุจูุฉ
  /// โ Hint: ุฅุฐุง ูุงู ุงููุต ุนุฑุจู โ ุชุฑุฌูุฉ ููุฅูุฌููุฒูุฉ
  /// โ Hint: ุฅุฐุง ูุงู ุงููุต ุฅูุฌููุฒู โ ุชุฑุฌูุฉ ููุนุฑุจูุฉ
  ///
  /// ุงููุนุงููุงุช:
  /// - [text] ุงููุต ุงููุฑุงุฏ ุชุฑุฌูุชู
  ///
  /// ุงูุนูุฏุฉ:
  /// - (ุงููุต ุงููุชุฑุฌูุ ุงููุบุฉ ุงููุตุฏุฑ)
  /// - null ูู ุญุงูุฉ ุงููุดู
  Future<(String translatedText, String sourceLang)?> translateAuto(String text) async {
    try {
      // โ Hint: ุงูุชุญูู ูู ุฃู ุงููุต ููุณ ูุงุฑุบุงู
      if (text.trim().isEmpty) {
        return null;
      }

      // โ Hint: ุงูุชุดุงู ุงููุบุฉ ุฃููุงู
      final detected = await _translator
          .translate(text, from: 'auto', to: 'en')
          .timeout(_timeout);

      final sourceLang = detected.sourceLanguage.code;

      // โ Hint: ุงูุชุฑุฌูุฉ ุจูุงุกู ุนูู ุงููุบุฉ ุงูููุชุดูุฉ
      if (sourceLang == 'ar') {
        // ุนุฑุจู โ ุฅูุฌููุฒู
        final translation = await translateToEnglish(text);
        if (translation != null) {
          return (translation, 'ar');
        }
      } else {
        // ุฅูุฌููุฒู โ ุนุฑุจู
        final translation = await translateToArabic(text);
        if (translation != null) {
          return (translation, 'en');
        }
      }

      return null;

    } catch (e) {
      // โ Hint: ูู ุญุงูุฉ ุงูุฎุทุฃ
      return null;
    }
  }

  /// ุงูุชุญูู ูู ุฃู ุงููุต ุนุฑุจู
  ///
  /// โ Hint: ูุญุต ุจุณูุท ูุนุชูุฏ ุนูู ูุทุงู Unicode ููุฃุญุฑู ุงูุนุฑุจูุฉ
  ///
  /// ุงููุนุงููุงุช:
  /// - [text] ุงููุต ุงููุฑุงุฏ ูุญุตู
  ///
  /// ุงูุนูุฏุฉ:
  /// - true ุฅุฐุง ูุงู ุงููุต ูุญุชูู ุนูู ุฃุญุฑู ุนุฑุจูุฉ
  bool isArabic(String text) {
    if (text.trim().isEmpty) return false;

    // โ Hint: ูุทุงู Unicode ููุฃุญุฑู ุงูุนุฑุจูุฉ: U+0600 to U+06FF
    final arabicRegex = RegExp(r'[\u0600-\u06FF]');
    return arabicRegex.hasMatch(text);
  }

  /// ุงูุชุญูู ูู ุฃู ุงููุต ุฅูุฌููุฒู
  ///
  /// โ Hint: ูุญุต ุจุณูุท ูุนุชูุฏ ุนูู ุงูุฃุญุฑู ุงููุงุชูููุฉ
  ///
  /// ุงููุนุงููุงุช:
  /// - [text] ุงููุต ุงููุฑุงุฏ ูุญุตู
  ///
  /// ุงูุนูุฏุฉ:
  /// - true ุฅุฐุง ูุงู ุงููุต ูุญุชูู ุนูู ุฃุญุฑู ุฅูุฌููุฒูุฉ
  bool isEnglish(String text) {
    if (text.trim().isEmpty) return false;

    // โ Hint: ุงูุฃุญุฑู ุงููุงุชูููุฉ: a-z, A-Z
    final englishRegex = RegExp(r'[a-zA-Z]');
    return englishRegex.hasMatch(text);
  }
}
