rules_version = '2';

// ===========================================================================
// ๐ Firestore Security Rules - Accounting App
// ===========================================================================
//
// ุงููุฏู: ุญูุงูุฉ ุจูุงูุงุช ุงูุงุดุชุฑุงูุงุช ูู Firestore
//
// ุงููุจุงุฏุฆ:
// - โ ูู ูุณุชุฎุฏู ููุฑุฃ/ููุชุจ ุงุดุชุฑุงูู ููุท
// - โ ูุง ูููู ูุฑุงุกุฉ ุงุดุชุฑุงูุงุช ุงูุขุฎุฑูู
// - โ ูุง ูููู ุชุนุฏูู ุงูุญููู ุงูุญุณุงุณุฉ (plan, maxDevices, endDate)
// - โ ูููู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฃุฌูุฒุฉ ููุท
//
// ===========================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ๐ฆ Collection: subscriptions
    // =========================================================================
    // ุงูุจููุฉ: subscriptions/{email}
    //
    // ุงูุญููู:
    // - email: String (ููุชุงุญ ุฃุณุงุณู)
    // - plan: String (trial, professional, enterprise)
    // - status: String (active, expired, suspended)
    // - isActive: Boolean
    // - startDate: Timestamp
    // - endDate: Timestamp
    // - maxDevices: Number (3, 10, unlimited)
    // - currentDevices: Array of Strings (device fingerprints)
    // - features: Map
    // - paymentHistory: Array
    //
    // =========================================================================

    match /subscriptions/{email} {

      // =======================================================================
      // ุงููุงุนุฏุฉ 1: ุงููุฑุงุกุฉ (Read)
      // =======================================================================
      // ุงูุดุฑูุท:
      // - ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู (authenticated)
      // - Email ุงููุณุชุฎุฏู = email ูู ุงูู document
      //
      // Hint: request.auth.token.email ูุญุชูู ุนูู email ุงููุณุชุฎุฏู ูู Firebase Auth
      // =======================================================================

      allow read: if request.auth != null
                  && request.auth.token.email == email;

      // =======================================================================
      // ุงููุงุนุฏุฉ 2: ุงูุฅูุดุงุก (Create)
      // =======================================================================
      // ุงูุดุฑูุท:
      // - ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
      // - Email ุงููุณุชุฎุฏู = email ูู ุงูู document
      // - ููุณุชุฎุฏู ููุท ุนูุฏ ุงูุชุณุฌูู ุงูุฃูู (ูู register_screen.dart)
      //
      // Hint: ูุฐู ุงููุงุนุฏุฉ ุชุณูุญ ุจุฅูุดุงุก ุงุดุชุฑุงู ุชุฌุฑูุจู ุชููุงุฆูุงู
      // =======================================================================

      allow create: if request.auth != null
                    && request.auth.token.email == email;

      // =======================================================================
      // ุงููุงุนุฏุฉ 3: ุงูุชุญุฏูุซ (Update)
      // =======================================================================
      // ุงูุดุฑูุท:
      // - ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
      // - Email ุงููุณุชุฎุฏู = email ูู ุงูู document
      // - ูููู ุชุญุฏูุซ: currentDevices ู updatedAt ููุท
      //
      // Hint: request.resource.data ูู ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
      // Hint: resource.data ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ
      // Hint: diff() ูุญุณุจ ุงููุฑู ุจูู ุงููุฏูู ูุงูุฌุฏูุฏ
      // Hint: affectedKeys() ูุนุทู ูุงุฆูุฉ ุงูุญููู ุงููุชุบูุฑุฉ
      // Hint: hasOnly() ูุชุญูู ุฃู ุงููุงุฆูุฉ ุชุญุชูู ุนูู ุงูุนูุงุตุฑ ุงููุญุฏุฏุฉ ููุท
      //
      // ุฃูุซูุฉ ูุณููุญุฉ:
      // - ุฅุถุงูุฉ ุฌูุงุฒ ุฌุฏูุฏ ูู currentDevices โ
      // - ุฅุฒุงูุฉ ุฌูุงุฒ ูู currentDevices โ
      // - ุชุญุฏูุซ updatedAt โ
      //
      // ุฃูุซูุฉ ููููุนุฉ:
      // - ุชุนุฏูู plan (ูู trial ุฅูู professional) โ
      // - ุชุนุฏูู maxDevices (ูู 3 ุฅูู 10) โ
      // - ุชุนุฏูู endDate (ุชูุฏูุฏ ุงูุงุดุชุฑุงู) โ
      // - ุชุนุฏูู isActive (ุชูุนูู ุงุดุชุฑุงู ููุชูู) โ
      //
      // =======================================================================

      allow update: if request.auth != null
                    && request.auth.token.email == email
                    && request.resource.data.diff(resource.data)
                       .affectedKeys()
                       .hasOnly(['currentDevices', 'updatedAt']);

      // =======================================================================
      // ุงููุงุนุฏุฉ 4: ุงูุญุฐู (Delete)
      // =======================================================================
      // โ ููููุน ุชูุงูุงู - ูุง ูููู ูุฃู ูุณุชุฎุฏู ุญุฐู ุงุดุชุฑุงูู
      //
      // Hint: ุงูุญุฐู ูุชู ููุท ูู Firebase Console ุฃู Cloud Functions
      // =======================================================================

      // ูุง ุชูุฌุฏ ูุงุนุฏุฉ delete โ ููููุน ุงูุชุฑุงุถูุงู
    }

    // =========================================================================
    // ๐ซ ุงููุงุนุฏุฉ ุงูุงูุชุฑุงุถูุฉ: ุฑูุถ ูู ุดูุก ุขุฎุฑ
    // =========================================================================
    // ุฃู collection ุฃู document ุขุฎุฑ โ ููููุน
    // =======================================================================
  }
}

// =============================================================================
// ๐ ููุงุญุธุงุช ูููุทูุฑ:
// =============================================================================
//
// 1. ููููุฉ ุงููุดุฑ:
//    - ุงูุชุญ Firebase Console โ Firestore Database โ Rules
//    - ุงูุณุฎ ูุญุชูู ูุฐุง ุงูููู
//    - ุงูุตู ูู ุงููุญุฑุฑ
//    - ุงููุฑ "Publish"
//
// 2. ุงูุงุฎุชุจุงุฑ:
//    - ุงูุชุญ Rules โ Simulator
//    - ุงุฎุชุจุฑ ุงูู read/write operations
//
// 3. ุงููุฑุงูุจุฉ:
//    - ุงูุชุญ Usage โ Requests
//    - ุชุงุจุน ุงูู denied requests
//
// 4. Best Practices:
//    - ูุง ุชุณูุญ ุจู read/write ุนูู collection ูุงููุฉ
//    - ุงุณุชุฎุฏู document-level security
//    - ุชุญูู ูู auth ุฏุงุฆูุงู
//    - ุงุณุชุฎุฏู hasOnly() ูุชุญุฏูุฏ ุงูุญููู ุงููุณููุญุฉ
//
// =============================================================================
